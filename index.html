<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team KPI Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Mulish:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script id="syncConfig" type="application/json">{"dbUrl":"https://hlkpi-853c1-default-rtdb.firebaseio.com"}</script>
<style>
:root{--cream:#f8f5f0;--warm:#f0ebe2;--warm2:#e5ddd0;--border:#ddd5c4;--border2:#c9baa4;--text:#201a10;--muted:#9a8a72;--surface:#fff;--red:#c0392b;--orange:#d4650a;--green:#1e8a52;--blue:#1a6fa8;--shadow:0 2px 16px rgba(44,36,22,.09);}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Mulish',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;}
.hidden{display:none!important;}

/* Host warning screen */
#hostWarning{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px 20px;background:var(--cream);}
.hw-wrap{width:100%;max-width:640px;}
.hw-logo{font-family:'Playfair Display',serif;font-size:32px;font-weight:800;color:var(--text);margin-bottom:20px;text-align:center;}
.hw-logo em{color:var(--red);font-style:normal;}
.hw-card{background:var(--surface);border:2px solid var(--orange);border-radius:16px;padding:32px;margin-bottom:20px;}
.hw-title{font-family:'Playfair Display',serif;font-size:24px;font-weight:700;color:var(--orange);margin-bottom:16px;text-align:center;}
.hw-desc{font-size:14px;color:var(--text);line-height:1.8;margin-bottom:20px;}
.hw-desc strong{font-weight:800;}
.hw-steps{background:var(--cream);border-radius:12px;padding:20px;margin:20px 0;}
.hw-step{font-size:14px;color:var(--text);line-height:2;margin-bottom:8px;}
.hw-step strong{color:var(--red);font-weight:800;}
.hw-step code{background:var(--warm2);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:13px;}
.hw-note{background:#fef3e5;border:1px solid #f5d5a8;border-radius:10px;padding:16px;font-size:13px;line-height:1.7;color:var(--text);}

/* Setup */
#setupScreen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px 20px;background:radial-gradient(ellipse at 10% 90%,rgba(192,57,43,.06) 0%,transparent 55%),var(--cream);}
.wrap{width:100%;max-width:600px;}
.logo{font-family:'Playfair Display',serif;font-size:30px;font-weight:800;color:var(--text);margin-bottom:6px;}
.logo em{color:var(--red);font-style:normal;}
.intro{font-size:14px;color:var(--muted);line-height:1.7;margin-bottom:24px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:14px;}
.cnum{font-size:10px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.ctitle{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;margin-bottom:8px;}
.cdesc{font-size:13px;color:var(--muted);line-height:1.7;margin-bottom:14px;}
.cdesc a{color:var(--red);font-weight:700;text-decoration:none;}
.cdesc a:hover{text-decoration:underline;}
.cdesc code{background:var(--warm);padding:2px 6px;border-radius:4px;font-size:12px;color:var(--text);font-family:monospace;}
.ol{padding-left:18px;font-size:13px;color:var(--muted);line-height:2.2;margin-bottom:14px;}
.ol li strong{color:var(--text);}
.ol li code{background:var(--warm);padding:1px 5px;border-radius:3px;font-size:12px;color:var(--text);font-family:monospace;}
.code-block{background:#1e1e2e;border-radius:10px;padding:14px;margin:10px 0 14px 0;position:relative;}
.code-block pre{color:#a6e3a1;font-size:11px;line-height:1.6;overflow-x:auto;white-space:pre;font-family:'Courier New',monospace;margin:0;}
.copy-btn{position:absolute;top:8px;right:8px;background:#3b3b52;color:#ccc;border:none;border-radius:5px;padding:4px 10px;font-size:10px;cursor:pointer;font-family:'Mulish',sans-serif;font-weight:700;}
.copy-btn:hover{background:#505070;color:#fff;}
.finput{width:100%;background:var(--cream);border:1.5px solid var(--border);border-radius:9px;padding:11px 14px;font-family:'Mulish',sans-serif;font-size:14px;color:var(--text);outline:none;transition:border-color .2s,background .2s;margin-bottom:12px;}
.finput:focus{border-color:var(--red);background:#fff;}
.finput::placeholder{color:var(--muted);}
.btn{border:none;border-radius:10px;padding:12px 26px;font-family:'Mulish',sans-serif;font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;}
.btn.red{background:var(--red);color:#fff;} .btn.red:hover{background:#a93226;transform:translateY(-1px);}
.btn:disabled{background:var(--muted)!important;cursor:not-allowed;transform:none!important;}
.smsg{font-size:13px;padding:10px 14px;border-radius:8px;margin-top:10px;line-height:1.5;}
.smsg.err{background:#fdecea;color:var(--red);border:1px solid #f5c6c3;}
.smsg.ok{background:#e5f5ec;color:var(--green);border:1px solid #b2dfcc;}
.smsg.info{background:var(--warm);color:var(--muted);border:1px solid var(--border);}

/* Login */
#loginScreen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px 20px;background:radial-gradient(ellipse at 10% 90%,rgba(192,57,43,.05) 0%,transparent 55%),var(--cream);}
.lwrap{width:100%;max-width:480px;}
.leyebrow{font-size:11px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.ltitle{font-family:'Playfair Display',serif;font-size:38px;font-weight:800;line-height:1.1;color:var(--text);margin-bottom:8px;}
.ltitle em{color:var(--red);font-style:normal;}
.lsub{font-size:14px;color:var(--muted);line-height:1.6;margin-bottom:12px;}
.month-tag{display:inline-flex;align-items:center;gap:6px;background:var(--warm);border:1px solid var(--border);border-radius:99px;padding:5px 14px;font-size:12px;font-weight:700;color:var(--text);margin-bottom:32px;}
.sync-pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--green);font-weight:700;background:#e5f5ec;border:1px solid #b2dfcc;border-radius:99px;padding:4px 12px;margin-bottom:16px;}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1.8s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.llabel{font-size:11px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:28px;}
.mbtn{background:var(--surface);border:2px solid var(--border);border-radius:14px;padding:18px 14px;cursor:pointer;text-align:center;transition:all .2s;}
.mbtn:hover{border-color:var(--red);transform:translateY(-2px);box-shadow:0 6px 20px rgba(192,57,43,.14);}
.mbtn .av{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-weight:700;font-size:18px;color:#fff;margin:0 auto 10px;}
.mbtn .nm{font-size:13px;font-weight:800;color:var(--text);}
.mbtn .rl{font-size:11px;color:var(--muted);margin-top:2px;}
.mbtn .kc{font-size:10px;color:var(--blue);font-weight:700;margin-top:4px;}
.arow{text-align:center;padding-top:12px;border-top:1px solid var(--border);}
.alink{font-size:12px;color:var(--muted);cursor:pointer;text-decoration:underline;text-underline-offset:3px;background:none;border:none;font-family:'Mulish',sans-serif;}
.alink:hover{color:var(--red);}

/* App - same styles as before, condensed for space */
#appScreen{min-height:100vh;display:flex;flex-direction:column;}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 36px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.tbl{display:flex;align-items:center;gap:12px;}
.tbav{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-weight:700;font-size:14px;color:#fff;flex-shrink:0;}
.tbname{font-family:'Playfair Display',serif;font-size:16px;font-weight:700;}
.tbsub{font-size:11px;color:var(--muted);}
.tbr{display:flex;align-items:center;gap:10px;}
.tpill{background:var(--warm);border:1px solid var(--border);border-radius:7px;padding:6px 13px;font-size:12px;font-weight:700;}
.sbadge{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:6px 12px;border-radius:7px;border:1px solid;}
.sbadge.live{color:var(--green);background:#e5f5ec;border-color:#b2dfcc;}
.sbadge.sync{color:var(--orange);background:#fef3e5;border-color:#f5d5a8;}
.sbadge.err{color:var(--red);background:#fdecea;border-color:#f5c6c3;}
.sbd{width:6px;height:6px;border-radius:50%;background:currentColor;}
.sbd.spin{animation:pulse 1.2s infinite;}
.tbtn{background:none;border:1px solid var(--border);border-radius:7px;padding:6px 13px;font-family:'Mulish',sans-serif;font-size:12px;font-weight:700;color:var(--muted);cursor:pointer;}
.tbtn:hover{border-color:var(--red);color:var(--red);}
.tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);padding:0 36px;}
.tab{padding:11px 22px;font-family:'Mulish',sans-serif;font-size:13px;font-weight:700;color:var(--muted);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--red);border-bottom-color:var(--red);}
.content{padding:36px;max-width:980px;margin:0 auto;width:100%;}
.panel{display:none;}
.panel.active{display:block;animation:fu .25s ease;}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.sh{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;margin-bottom:4px;}
.ss{font-size:13px;color:var(--muted);margin-bottom:26px;line-height:1.5;}

/* All other styles condensed -kat cards, entries, team, history, admin (omitted for brevity but same as localStorage version) */
.catgrid{display:grid;gap:16px;margin-bottom:24px;}
.kcard{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px 20px;position:relative;overflow:hidden;transition:box-shadow .2s,transform .2s;}
.kcard:hover{transform:translateY(-2px);box-shadow:var(--shadow);}
.kcard::before{content:'';position:absolute;bottom:-16px;right:-16px;width:72px;height:72px;border-radius:50%;opacity:.07;}
.kcard.k-sales::before{background:var(--red);}.kcard.k-tasks::before{background:var(--green);}
.kcard.k-outreach::before{background:var(--blue);}.kcard.k-other::before{background:var(--orange);}
.kico{font-size:20px;margin-bottom:10px;}
.kcat{font-size:10px;font-weight:800;letter-spacing:1.4px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.kpct{font-family:'Playfair Display',serif;font-size:40px;font-weight:800;line-height:1;margin-bottom:4px;}
.kdet{font-size:12px;color:var(--muted);}
.mbar{height:5px;background:var(--warm2);border-radius:99px;margin-top:14px;overflow:hidden;}
.mbar-fill{height:100%;border-radius:99px;transition:width 1s cubic-bezier(.16,1,.3,1);}
.r{color:var(--red);}.g{color:var(--green);}.b{color:var(--blue);}.o{color:var(--orange);}
.fr{background:var(--red);}.fg{background:var(--green);}.fb{background:var(--blue);}.fo{background:var(--orange);}
.slabel{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.krows{display:flex;flex-direction:column;gap:10px;}
.krow{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:18px;}
.krow:hover{border-color:var(--border2);}
.krl{flex:1;}
.kname{font-size:14px;font-weight:700;margin-bottom:3px;}
.knums{font-size:12px;color:var(--muted);}
.knums strong{color:var(--text);font-weight:700;}
.kbw{width:160px;flex-shrink:0;}
.kpr{display:flex;justify-content:space-between;font-size:11px;font-weight:700;margin-bottom:5px;}
.b6{height:6px;background:var(--warm2);border-radius:99px;overflow:hidden;}
.b6f{height:100%;border-radius:99px;transition:width 1s cubic-bezier(.16,1,.3,1);}
.kbig{width:80px;text-align:right;flex-shrink:0;font-family:'Playfair Display',serif;font-size:20px;font-weight:700;}
.catblock{margin-bottom:28px;}
.cathd{display:flex;align-items:center;gap:9px;padding-bottom:10px;margin-bottom:14px;border-bottom:2px solid var(--warm2);}
.erows{display:flex;flex-direction:column;gap:10px;}
.erow{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;display:grid;grid-template-columns:1fr 190px 130px;gap:16px;align-items:center;}
.erow:hover{border-color:var(--border2);}
.ename{font-size:14px;font-weight:700;margin-bottom:3px;}
.eprog{font-size:12px;color:var(--muted);}
.eprog strong{color:var(--text);}
.epr{display:flex;justify-content:space-between;font-size:11px;font-weight:700;margin-bottom:4px;}
.b5{height:5px;background:var(--warm2);border-radius:99px;overflow:hidden;}
.b5f{height:100%;border-radius:99px;}
.eiw{display:flex;align-items:center;gap:7px;}
.einput{width:100%;background:var(--cream);border:1.5px solid var(--border);border-radius:8px;padding:9px 12px;text-align:center;font-family:'Mulish',sans-serif;font-size:15px;font-weight:800;color:var(--text);outline:none;transition:border-color .2s,background .2s;}
.einput:focus{border-color:var(--red);background:#fff;}
.eunit{font-size:11px;color:var(--muted);font-weight:700;}
.saverow{margin-top:8px;}
.savebtn{background:var(--red);color:#fff;border:none;border-radius:10px;padding:13px 32px;font-family:'Mulish',sans-serif;font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;}
.savebtn:hover{background:#a93226;transform:translateY(-1px);box-shadow:0 6px 20px rgba(192,57,43,.3);}
.savebtn:disabled{background:var(--muted);cursor:not-allowed;transform:none;}
.tnote{background:var(--warm);border:1px solid var(--border);border-radius:10px;padding:14px 18px;font-size:13px;font-weight:500;margin-bottom:26px;line-height:1.6;}
.tblocks{display:flex;flex-direction:column;gap:16px;}
.tcard{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px 26px;}
.thd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px;}
.tname{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;}
.tcat{font-size:11px;color:var(--muted);margin-top:3px;}
.tac{font-size:11px;color:var(--blue);font-weight:700;margin-top:4px;}
.trt{text-align:right;}
.tpct{font-family:'Playfair Display',serif;font-size:36px;font-weight:800;line-height:1;}
.tsub{font-size:11px;color:var(--muted);margin-top:2px;}
.bigbar{height:10px;background:var(--warm2);border-radius:99px;overflow:hidden;margin-bottom:14px;}
.bigfill{height:100%;border-radius:99px;transition:width 1.1s cubic-bezier(.16,1,.3,1);}
.teamrow{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);flex-wrap:wrap;gap:8px;}
.teamrow strong{color:var(--text);font-weight:700;}
.hlist{display:flex;flex-direction:column;gap:9px;}
.hentry{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:16px;}
.hentry:hover{border-color:var(--border2);}
.hdate{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:2px;text-transform:uppercase;}
.hkpi{font-size:14px;font-weight:700;}
.hcat{display:inline-block;font-size:10px;font-weight:800;text-transform:uppercase;border-radius:4px;padding:2px 7px;margin-left:7px;}
.hcat.sales{background:#fdecea;color:var(--red);}.hcat.tasks{background:#e5f5ec;color:var(--green);}
.hcat.outreach{background:#e5f0f8;color:var(--blue);}.hcat.other{background:#fef3e5;color:var(--orange);}
.hval{font-family:'Playfair Display',serif;font-size:22px;font-weight:800;display:flex;align-items:baseline;gap:5px;}
.hu{font-size:12px;color:var(--muted);font-family:'Mulish',sans-serif;font-weight:600;}
.acrd{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:20px;}
.acrd h3{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;margin-bottom:6px;}
.acrd p{font-size:13px;color:var(--muted);margin-bottom:18px;line-height:1.6;}
.srows{display:flex;flex-direction:column;gap:9px;margin-bottom:14px;}
.srow{display:flex;align-items:center;gap:10px;background:var(--cream);border:1px solid var(--border);border-radius:9px;padding:11px 14px;}
.sin{background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Mulish',sans-serif;font-size:13px;padding:8px 11px;outline:none;flex:1;min-width:100px;}
.sin:focus{border-color:var(--red);}
.scat{background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Mulish',sans-serif;font-size:13px;padding:8px 11px;outline:none;cursor:pointer;width:140px;}
.rmbtn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:3px;}
.rmbtn:hover{color:var(--red);}
.addbtn{display:flex;align-items:center;justify-content:center;width:100%;background:none;border:1.5px dashed var(--border);border-radius:9px;padding:11px;font-family:'Mulish',sans-serif;font-size:13px;font-weight:700;color:var(--muted);cursor:pointer;margin-bottom:18px;}
.addbtn:hover{border-color:var(--red);color:var(--red);}
.psel{background:#fff;border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Mulish',sans-serif;font-size:13px;padding:9px 13px;outline:none;cursor:pointer;margin-bottom:18px;}
.actbtn{background:var(--red);color:#fff;border:none;border-radius:9px;padding:11px 24px;font-family:'Mulish',sans-serif;font-size:13px;font-weight:800;cursor:pointer;transition:all .2s;}
.actbtn:hover{background:#a93226;}
.actbtn.gr{background:var(--muted);}.actbtn.gr:hover{background:#7a6a56;}
.atw{overflow-x:auto;margin-bottom:18px;}
.atable{width:100%;border-collapse:collapse;font-size:13px;}
.atable th{background:var(--warm);padding:9px 14px;text-align:left;font-size:11px;font-weight:800;text-transform:uppercase;color:var(--muted);border-bottom:2px solid var(--border);}
.atable th.c,.atable td.c{text-align:center;}
.atable td{padding:10px 14px;border-bottom:1px solid var(--border);}
.atable tr:last-child td{border-bottom:none;}
.atable tr:hover td{background:var(--cream);}
.ginput{width:80px;background:var(--cream);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Mulish',sans-serif;font-size:13px;font-weight:700;padding:6px 9px;outline:none;text-align:center;}
.ginput:focus{border-color:var(--red);background:#fff;}
.ginput:disabled{opacity:.35;cursor:not-allowed;}
.ach{width:18px;height:18px;cursor:pointer;accent-color:var(--red);}
.empty{text-align:center;padding:60px 20px;color:var(--muted);font-size:14px;}
.empty .ei{font-size:36px;margin-bottom:10px;}
.toast{position:fixed;bottom:28px;right:28px;z-index:999;color:#fff;padding:13px 22px;border-radius:10px;font-family:'Mulish',sans-serif;font-size:13px;font-weight:800;opacity:0;transform:translateY(16px);transition:all .3s;pointer-events:none;max-width:340px;}
.toast.on{opacity:1;transform:translateY(0);}
.ac0{background:#c0392b;}.ac1{background:#1a6fa8;}.ac2{background:#1e8a52;}.ac3{background:#d4650a;}.ac4{background:#7b3fa8;}
#ov{position:fixed;inset:0;background:rgba(248,245,240,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:14px;}
.spin{width:36px;height:36px;border:3px solid var(--warm2);border-top-color:var(--red);border-radius:50%;animation:sp .8s linear infinite;}
@keyframes sp{to{transform:rotate(360deg)}}
.ltxt{font-size:14px;font-weight:700;color:var(--muted);}
</style>
</head>
<body>

<div id="ov"><div class="spin"></div><div class="ltxt">Loading‚Ä¶</div></div>

<!-- Host Warning (shown when running from file://) -->
<div id="hostWarning" class="hidden">
  <div class="hw-wrap">
    <div class="hw-logo">KPI <em>Tracker</em></div>
    <div class="hw-card">
      <div class="hw-title">‚ö†Ô∏è Please host this file first</div>
      <div class="hw-desc">
        <strong>Synced KPI tracking requires hosting.</strong> Local HTML files (file://) cannot connect to Firebase due to browser security restrictions (CORS).
      </div>
      <div class="hw-steps">
        <div class="hw-step"><strong>1.</strong> Go to <a href="https://app.netlify.com/drop" target="_blank" style="color:var(--red);text-decoration:underline;">app.netlify.com/drop</a></div>
        <div class="hw-step"><strong>2.</strong> Drag this HTML file onto the page</div>
        <div class="hw-step"><strong>3.</strong> Netlify will give you a URL like <code>https://random-name.netlify.app</code></div>
        <div class="hw-step"><strong>4.</strong> Open that URL in your browser</div>
        <div class="hw-step"><strong>5.</strong> Complete Firebase setup from the hosted page</div>
        <div class="hw-step"><strong>6.</strong> Share the Netlify URL with your team</div>
      </div>
      <div class="hw-note">
        <strong>Why hosting?</strong> Browsers block network requests from local files to prevent security attacks. Netlify is free, takes 30 seconds, and gives you a permanent shareable URL that your whole team can use.
      </div>
    </div>
  </div>
</div>

<!-- Setup (shown once hosted, no Firebase configured yet) -->
<div id="setupScreen" class="hidden">
<div class="wrap">
  <div class="logo">KPI <em>Tracker</em></div>
  <div class="intro">Quick Firebase setup for team sync. Takes about 3 minutes.</div>

  <div class="card">
    <div class="cnum">Step 1 ‚Äî Create Database</div>
    <div class="ctitle">Set up Firebase Realtime Database</div>
    <ol class="ol">
      <li>Go to <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a></li>
      <li>Click <strong>Add project</strong> ‚Üí name it anything ‚Üí next through setup</li>
      <li>Left menu: <strong>Build ‚Üí Realtime Database</strong></li>
      <li>Click <strong>Create Database</strong> ‚Üí choose location ‚Üí Next</li>
      <li>Select <strong>"Start in test mode"</strong> ‚Üí Enable</li>
      <li>Click <strong>Rules</strong> tab, replace everything with:</li>
    </ol>
    <div class="code-block">
      <button class="copy-btn" id="copyBtn" onclick="copyRules()">Copy</button>
      <pre id="rulesCode">{
  "rules": {
    ".read": true,
    ".write": true
  }
}</pre>
    </div>
    <ol class="ol" start="7">
      <li>Click <strong>Publish</strong></li>
      <li>Copy your database URL (looks like <code>https://yourproject-default-rtdb.firebaseio.com</code>)</li>
    </ol>
  </div>

  <div class="card">
    <div class="cnum">Step 2 ‚Äî Connect</div>
    <div class="ctitle">Paste your Database URL</div>
    <input class="finput" type="text" id="dbUrlInput" placeholder="https://yourproject-default-rtdb.firebaseio.com"/>
    <button class="btn red" id="connectBtn" onclick="doConnect()">Connect ‚Üí</button>
    <div id="connectMsg"></div>
  </div>
</div>
</div>

<!-- Login -->
<div id="loginScreen" class="hidden">
<div class="lwrap">
  <div class="leyebrow">Team Performance</div>
  <div class="ltitle">Monthly<br><em>KPI Tracker</em></div>
  <div class="lsub">Track individual KPIs with personal targets. View collective team progress.</div>
  <div class="sync-pill"><div class="sdot"></div>Live sync enabled</div><br>
  <div class="month-tag" id="loginMonth"></div>
  <div class="llabel">Who are you?</div>
  <div class="mgrid" id="memberGrid"></div>
  <div class="arow"><button class="alink" onclick="loginAdmin()">‚öô Admin</button></div>
</div>
</div>

<!-- App (full implementation same as before, condensed) -->
<div id="appScreen" class="hidden">
  <div class="topbar">
    <div class="tbl">
      <div class="tbav" id="tbAv"></div>
      <div><div class="tbname" id="tbName"></div><div class="tbsub" id="tbSub"></div></div>
    </div>
    <div class="tbr">
      <div class="sbadge live" id="sbadge"><div class="sbd"></div><span id="stxt">Live</span></div>
      <div class="tpill" id="tbPill"></div>
      <button class="tbtn" onclick="signOut()">Sign out</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="showTab('dashboard',this)">My Dashboard</button>
    <button class="tab" onclick="showTab('entry',this)">Log Today</button>
    <button class="tab" onclick="showTab('team',this)">Team Progress</button>
    <button class="tab" onclick="showTab('history',this)">My History</button>
    <button class="tab ao hidden" onclick="showTab('admin',this)">‚öô Admin</button>
  </div>
  <div class="content">
    <div class="panel active" id="panel-dashboard">
      <div class="sh" id="greet"></div>
      <div class="ss">Your personal KPIs.</div>
      <div class="catgrid" id="catCards"></div>
      <div class="slabel">My Assigned KPIs</div>
      <div class="krows" id="kpiRows"></div>
    </div>
    <div class="panel" id="panel-entry">
      <div class="sh">Log Today's Progress</div>
      <div class="ss" id="entrySub"></div>
      <div id="entryCats"></div>
      <div class="saverow"><button class="savebtn" id="saveBtn" onclick="saveEntry()">‚úì Save Entry</button></div>
    </div>
    <div class="panel" id="panel-team">
      <div class="sh">Team Collective Progress</div>
      <div class="ss">Combined achievement toward total team target.</div>
      <div class="tnote"><strong>üîí Privacy:</strong> Combined totals only.</div>
      <div class="tblocks" id="teamBlocks"></div>
    </div>
    <div class="panel" id="panel-history">
      <div class="sh">My Log History</div>
      <div class="ss">All your entries, most recent first.</div>
      <div class="hlist" id="histList"></div>
    </div>
    <div class="panel" id="panel-admin">
      <div class="sh">Admin</div>
      <div class="ss">Configure team, KPIs, and assignments.</div>

      <div class="acrd">
        <h3>View Individual Performance</h3>
        <p>Select a team member to view their dashboard and entries.</p>
        <select class="psel" id="viewMemberSel" onchange="viewMemberPerformance()" style="margin-bottom:12px;">
          <option value="">-- Select Member --</option>
        </select>
        <div id="memberPerformance"></div>
      </div>

      <div class="acrd">
        <h3>Team Members</h3>
        <div class="srows" id="memberSetup"></div>
        <button class="addbtn" onclick="addMember()">+ Add Member</button>
      </div>
      <div class="acrd">
        <h3>KPI Library</h3>
        <div class="srows" id="kpiSetup"></div>
        <button class="addbtn" onclick="addKpi()">+ Add KPI</button>
      </div>
      <div class="acrd">
        <h3>Assign KPIs & Goals</h3>
        <div class="atw"><table class="atable" id="assignTable"></table></div>
        <button class="actbtn" onclick="saveAdmin()">üíæ Save All Changes</button>
        <button class="actbtn gr" onclick="resetEntries()" style="margin-left:10px">üîÑ Reset Entries</button>
      </div>
      <div class="acrd">
        <h3>Tracking Period</h3>
        <select class="psel" id="periodSel" onchange="S.period=this.value;">
          <option value="Weekly">Weekly</option>
          <option value="Monthly">Monthly</option>
          <option value="Quarterly">Quarterly</option>
          <option value="Annual">Annual</option>
        </select>
      </div>

      <div class="acrd">
        <h3>Admin Password</h3>
        <p>Change the password required to access admin panel.</p>
        <input type="text" class="finput" id="adminPwInput" placeholder="Enter new password" style="margin-bottom:12px;"/>
        <button class="actbtn" onclick="changeAdminPassword()">Update Password</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// Firebase
let DB='';
try{DB=JSON.parse(document.getElementById('syncConfig').textContent.trim()).dbUrl||'';}catch(e){}

async function fbRead(){
  const r = await fetch(DB + '/kpidata.json');
  if(!r.ok) throw new Error('HTTP ' + r.status);
  return await r.json() || {};
}

async function fbWrite(data){
  const r = await fetch(DB + '/kpidata.json', {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if(!r.ok) throw new Error('HTTP ' + r.status);
}

function copyRules(){navigator.clipboard.writeText(document.getElementById('rulesCode').textContent).then(()=>{const b=document.getElementById('copyBtn');b.textContent='Copied!';b.style.background='#40a870';b.style.color='#fff';setTimeout(()=>{b.textContent='Copy';b.style.background='';b.style.color='';},2200);});}

// State
const COLORS=['ac0','ac1','ac2','ac3','ac4'];
const CAT={sales:{label:'Sales & Revenue',icon:'üí∞',kc:'k-sales',hc:'sales',p:'r',f:'fr'},tasks:{label:'Task Completion',icon:'‚úÖ',kc:'k-tasks',hc:'tasks',p:'g',f:'fg'},outreach:{label:'Calls & Outreach',icon:'üìû',kc:'k-outreach',hc:'outreach',p:'b',f:'fb'},other:{label:'Other',icon:'üìå',kc:'k-other',hc:'other',p:'o',f:'fo'}};
const DEF={period:'Monthly',adminPassword:'admin123',members:[{id:1,name:'Sarah Chen',role:'Sales Executive',password:'sarah123'},{id:2,name:'Marcus Lee',role:'Account Manager',password:'marcus123'},{id:3,name:'Aisha Patel',role:'BDR',password:'aisha123'},{id:4,name:'Tom Rivera',role:'Sales Rep',password:'tom123'}],kpis:[{id:1,name:'Revenue Closed',unit:'$',cat:'sales'},{id:2,name:'Deals Signed',unit:'deals',cat:'sales'},{id:3,name:'Tasks Completed',unit:'tasks',cat:'tasks'},{id:4,name:'Reports Filed',unit:'rpts',cat:'tasks'},{id:5,name:'Calls Made',unit:'calls',cat:'outreach'},{id:6,name:'Meetings Booked',unit:'mtgs',cat:'outreach'}],assignments:{1:{1:{a:true,g:20000},2:{a:true,g:6},5:{a:true,g:80},6:{a:true,g:12}},2:{1:{a:true,g:15000},2:{a:true,g:4},5:{a:true,g:100},6:{a:true,g:15}},3:{3:{a:true,g:60},4:{a:true,g:10},5:{a:true,g:150},6:{a:true,g:20}},4:{1:{a:true,g:10000},3:{a:true,g:40},5:{a:true,g:90},6:{a:true,g:10}}},entries:[]};
let S=JSON.parse(JSON.stringify(DEF));
let CU=null,CT='dashboard',timer=null;

// Helper functions - MUST be defined before any function that uses them
const ini=n=>n.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
const clr=i=>COLORS[i%COLORS.length];
const mon=()=>new Date().toLocaleDateString('en-US',{month:'long',year:'numeric'});
const tod=()=>new Date().toISOString().split('T')[0];
const pct=(v,g)=>g?Math.min(100,Math.round(v/g*100)):0;
const pC=p=>p>=80?'g':p>=50?'o':'r';
const fC=p=>p>=80?'fg':p>=50?'fo':'fr';
const fmt=(v,u)=>u==='$'?'$'+Number(v).toLocaleString():Number(v).toLocaleString()+' '+u;
function asgn(mid){const m=(S.assignments||{})[mid]||{};return(S.kpis||[]).filter(k=>m[k.id]&&m[k.id].a).map(k=>({kpi:k,goal:m[k.id].g||0}));}
function mTot(mid,kid){return(S.entries||[]).filter(e=>e.mid===mid&&e.kid===kid).reduce((s,e)=>s+Number(e.v),0);}
function tTot(kid){return(S.entries||[]).filter(e=>e.kid===kid).reduce((s,e)=>s+Number(e.v),0);}
function tGoal(kid){return(S.members||[]).reduce((s,m)=>{const a=((S.assignments||{})[m.id]||{})[kid];return s+(a&&a.a?Number(a.g||0):0);},0);}
function mCats(mid){const s=new Set(),arr=[];asgn(mid).forEach(({kpi})=>{if(!s.has(kpi.cat)){s.add(kpi.cat);arr.push(kpi.cat);}});return arr;}
function cPct(mid,cat){const ks=asgn(mid).filter(({kpi})=>kpi.cat===cat);return ks.length?Math.round(ks.reduce((s,{kpi,goal})=>s+pct(mTot(mid,kpi.id),goal),0)/ks.length):0;}

// Setup
function setMsg(id,msg,type){const el=document.getElementById(id);el.className='smsg '+type;el.textContent=msg;}

async function doConnect(){
  let url=document.getElementById('dbUrlInput').value.trim().replace(/\/+$/,'');
  if(!url.includes('firebaseio.com')){setMsg('connectMsg','Please paste a valid Firebase URL (ends with .firebaseio.com)','err');return;}
  const btn=document.getElementById('connectBtn');btn.disabled=true;btn.textContent='Testing‚Ä¶';
  setMsg('connectMsg','Connecting to Firebase‚Ä¶','info');
  DB=url;
  try{
    const existing=await fbRead();
    if(existing&&Object.keys(existing).length>0){
      S = existing;
    }else{
      S = JSON.parse(JSON.stringify(DEF));
      await fbWrite(S);
    }
    // Save to localStorage so it persists across sessions
    localStorage.setItem('firebaseUrl',DB);
    setMsg('connectMsg','‚úì Connected! Loading app‚Ä¶','ok');
    setTimeout(()=>{
      document.getElementById('setupScreen').classList.add('hidden');
      renderLogin();
      document.getElementById('loginScreen').classList.remove('hidden');
      autoSync();
    },800);
  }catch(e){
    DB='';
    setMsg('connectMsg','‚ùå Failed: '+e.message+'. Make sure you set the security rules correctly.','err');
    btn.disabled=false;btn.textContent='Connect ‚Üí';
  }
}

// Boot
function boot(){
  if(window.location.protocol==='file:'){
    document.getElementById('ov').classList.add('hidden');
    document.getElementById('hostWarning').classList.remove('hidden');
    return;
  }
  
  const savedUrl = localStorage.getItem('firebaseUrl');
  if(savedUrl && !DB){
    DB = savedUrl;
  }
  
  if(!DB){
    document.getElementById('ov').classList.add('hidden');
    document.getElementById('setupScreen').classList.remove('hidden');
    return;
  }
  
  S = JSON.parse(JSON.stringify(DEF));
  document.getElementById('ov').classList.add('hidden');
  renderLogin();
  document.getElementById('loginScreen').classList.remove('hidden');
  
  loadFirebaseData();
}

async function loadFirebaseData(){
  try{
    const remote = await fbRead();
    if(remote && Object.keys(remote).length){
      S = remote;
      renderLogin();
    }else{
      await fbWrite(S);
    }
    autoSync();
  }catch(e){
    console.error('Firebase error:', e);
    showToast('‚ö†Ô∏è Could not sync with database.', '#d4650a');
  }
}

boot();

function autoSync(){
  if(timer)clearInterval(timer);
  timer=setInterval(async()=>{
    if(!CU)return;
    if(CT==='admin')return;
    try{
      setSB('sync','Syncing‚Ä¶');
      const r=await fbRead();
      if(r&&Object.keys(r).length){
        const currentJson = JSON.stringify(S);
        const remoteJson = JSON.stringify(r);
        if(currentJson !== remoteJson){
          S = r;
          renderAll();
        }
      }
      setSB('live','Live');
    }
    catch(e){setSB('err','Offline');}
  },30000);
}

async function push(){
  try{setSB('sync','Saving‚Ä¶');await fbWrite(S);setSB('live','Saved ‚úì');setTimeout(()=>setSB('live','Live'),2000);}
  catch(e){setSB('err','Save failed');showToast('‚ö†Ô∏è Could not save: '+e.message,'#d4650a');}
}

function setSB(t,tx){const b=document.getElementById('sbadge');if(!b)return;b.className='sbadge '+t;b.querySelector('.sbd').className='sbd'+(t==='sync'?' spin':'');document.getElementById('stxt').textContent=tx;}

// Login & Render functions
function renderLogin(){document.getElementById('loginMonth').textContent='üìÖ '+mon();const options=(S.members||[]).map(m=>`<option value="${m.id}">${m.name}</option>`).join('');document.getElementById('memberGrid').innerHTML=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;text-align:center;"><div style="font-size:14px;font-weight:700;margin-bottom:12px;color:var(--text);">Select Your Name</div><select id="memberSelect" style="width:100%;padding:12px;font-size:14px;border:1.5px solid var(--border);border-radius:9px;background:var(--cream);color:var(--text);outline:none;margin-bottom:16px;"><option value="">-- Choose --</option>${options}</select><button onclick="loginSelectedMember()" style="width:100%;background:var(--red);color:#fff;border:none;border-radius:10px;padding:13px;font-family:'Mulish',sans-serif;font-size:14px;font-weight:800;cursor:pointer;">Continue ‚Üí</button></div>`;}
function loginSelectedMember(){const sel=document.getElementById('memberSelect');const id=parseInt(sel.value);if(!id){alert('Please select your name');return;}const member=S.members.find(m=>m.id===id);if(!member){alert('Member not found');return;}const pw=prompt('Enter your password:');if(pw!==(member.password||'')){alert('Incorrect password');return;}loginAs(id);}
function loginAs(id){CU=S.members.find(m=>m.id===id);if(!CU)return;bootApp(false);}
function loginAdmin(){const pw=prompt('Enter Admin Password:');if(pw!==(S.adminPassword||'admin123')){alert('Incorrect password');return;}CU={admin:true,name:'Admin',id:0};bootApp(true);}
function signOut(){CU=null;if(timer)clearInterval(timer);document.getElementById('loginScreen').classList.remove('hidden');document.getElementById('appScreen').classList.add('hidden');renderLogin();autoSync();}
function bootApp(isAdmin){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('appScreen').classList.remove('hidden');const mi=isAdmin?0:S.members.indexOf(CU);const col=isAdmin?'ac4':clr(mi);const av=document.getElementById('tbAv');av.textContent=isAdmin?'‚öô':ini(CU.name);av.className='tbav '+col;document.getElementById('tbName').textContent=CU.name;document.getElementById('tbSub').textContent=isAdmin?'Administrator':(CU.role||'');document.getElementById('tbPill').textContent=(S.period||'Monthly')+' ¬∑ '+mon();document.querySelectorAll('.ao').forEach(el=>el.classList.toggle('hidden',!isAdmin));document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.getElementById('panel-dashboard').classList.add('active');document.querySelector('.tab').classList.add('active');CT='dashboard';renderAll();}
function showTab(n,b){
  CT=n;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+n).classList.add('active');
  if(b)b.classList.add('active');
  
  // Stop autoSync on admin panel to prevent overwriting unsaved changes
  if(n==='admin'){
    if(timer)clearInterval(timer);
    setSB('sync','Edit mode');
  }else{
    // Restart autoSync when leaving admin
    autoSync();
  }
  
  renderAll();
}
function renderAll(){if(!CU)return;const t=CT;if(t==='dashboard')rDash();if(t==='entry')rEntry();if(t==='team')rTeam();if(t==='history')rHist();if(t==='admin')rAdmin();}

// Dashboard,Entry,Team,History,Admin - same as localStorage version (omitted for brevity - full code would be here)
function rDash(){const uid=CU.admin?S.members[0]?.id:CU.id;const h=new Date().getHours();document.getElementById('greet').textContent=(h<12?'Good morning':h<17?'Good afternoon':'Good evening')+', '+(CU.name||'').split(' ')[0]+'!';if(!uid){document.getElementById('catCards').innerHTML='';document.getElementById('kpiRows').innerHTML='';return;}const cats=mCats(uid);const grid=document.getElementById('catCards');grid.style.gridTemplateColumns=`repeat(${Math.min(cats.length||1,3)},1fr)`;if(!cats.length){grid.innerHTML='<div class="empty"><div class="ei">üìã</div><p>No KPIs assigned.</p></div>';document.getElementById('kpiRows').innerHTML='';return;}grid.innerHTML=cats.map(cat=>{const m=CAT[cat]||CAT.other;const p=cPct(uid,cat);const ks=asgn(uid).filter(({kpi})=>kpi.cat===cat);return `<div class="kcard ${m.kc}"><div class="kico">${m.icon}</div><div class="kcat">${m.label}</div><div class="kpct ${pC(p)}">${p}%</div><div class="kdet">${ks.length} KPI${ks.length!==1?'s':''}</div><div class="mbar"><div class="mbar-fill ${fC(p)}" style="width:${p}%"></div></div></div>`;}).join('');document.getElementById('kpiRows').innerHTML=asgn(uid).map(({kpi,goal})=>{const val=mTot(uid,kpi.id);const p=pct(val,goal);const rem=Math.max(0,goal-val);const m=CAT[kpi.cat]||CAT.other;return `<div class="krow"><div class="krl"><div class="kname">${m.icon} ${kpi.name}</div><div class="knums">Achieved: <strong>${fmt(val,kpi.unit)}</strong> ¬∑ Target: <strong>${fmt(goal,kpi.unit)}</strong> ¬∑ Remaining: <strong>${fmt(rem,kpi.unit)}</strong></div></div><div class="kbw"><div class="kpr"><span style="color:var(--muted)">Progress</span><span class="${pC(p)}">${p}%</span></div><div class="b6"><div class="b6f ${fC(p)}" style="width:${p}%"></div></div></div><div class="kbig ${pC(p)}">${p}%</div></div>`;}).join('');}
function rEntry(){const uid=CU.admin?S.members[0]?.id:CU.id;document.getElementById('entrySub').textContent='Today is '+new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});const a=uid?asgn(uid):[];if(!a.length){document.getElementById('entryCats').innerHTML='<div class="empty"><div class="ei">üìã</div><p>No KPIs assigned.</p></div>';return;}const cm={};a.forEach(({kpi,goal})=>{if(!cm[kpi.cat])cm[kpi.cat]=[];cm[kpi.cat].push({kpi,goal});});document.getElementById('entryCats').innerHTML=Object.entries(cm).map(([cat,items])=>{const meta=CAT[cat]||CAT.other;const rows=items.map(({kpi,goal})=>{const val=uid?mTot(uid,kpi.id):0;const p=pct(val,goal);return `<div class="erow"><div><div class="ename">${kpi.name}</div><div class="eprog">So far: <strong>${fmt(val,kpi.unit)}</strong> of <strong>${fmt(goal,kpi.unit)}</strong></div></div><div><div class="epr"><span style="color:var(--muted)">Target</span><span class="${pC(p)}">${p}%</span></div><div class="b5"><div class="b5f ${fC(p)}" style="width:${p}%"></div></div></div><div class="eiw"><input class="einput" type="number" id="ei_${kpi.id}" min="0" placeholder="0"/><span class="eunit">${kpi.unit}</span></div></div>`;}).join('');return `<div class="catblock"><div class="cathd"><span style="font-size:18px">${meta.icon}</span><span style="font-size:12px;font-weight:800;text-transform:uppercase">${meta.label}</span></div><div class="erows">${rows}</div></div>`;}).join('');}
async function saveEntry(){const uid=CU.admin?S.members[0]?.id:CU.id;if(!uid)return;const btn=document.getElementById('saveBtn');btn.disabled=true;btn.textContent='Saving‚Ä¶';const td=tod();let saved=0;(asgn(uid)||[]).forEach(({kpi})=>{const el=document.getElementById('ei_'+kpi.id);if(!el)return;const v=parseFloat(el.value);if(!isNaN(v)&&v>0){if(!S.entries)S.entries=[];S.entries.push({id:Date.now()+Math.random(),mid:uid,kid:kpi.id,v,date:td});el.value='';saved++;}});if(!saved){btn.disabled=false;btn.textContent='‚úì Save Entry';return;}await push();renderAll();btn.disabled=false;btn.textContent='‚úì Save Entry';showToast('‚úì Entry saved!');}
function rTeam(){const el=document.getElementById('teamBlocks');const vis=(S.kpis||[]).filter(k=>(S.members||[]).some(m=>{const a=((S.assignments||{})[m.id]||{})[k.id];return a&&a.a;}));if(!vis.length){el.innerHTML='<div class="empty"><div class="ei">üìä</div><p>No KPIs assigned.</p></div>';return;}el.innerHTML=vis.map(k=>{const m=CAT[k.cat]||CAT.other;const ta=tTot(k.id);const tg=tGoal(k.id);const p=pct(ta,tg);const rem=Math.max(0,tg-ta);const ac=(S.members||[]).filter(mb=>{const a=((S.assignments||{})[mb.id]||{})[k.id];return a&&a.a;}).length;return `<div class="tcard"><div class="thd"><div><div class="tname">${m.icon} ${k.name}</div><div class="tcat">${m.label}</div><div class="tac">${ac} member${ac!==1?'s':''}</div></div><div class="trt"><div class="tpct ${pC(p)}">${p}%</div><div class="tsub">of team target</div></div></div><div class="bigbar"><div class="bigfill ${fC(p)}" style="width:${p}%"></div></div><div class="teamrow"><span>Achieved: <strong>${fmt(ta,k.unit)}</strong></span><span>Target: <strong>${fmt(tg,k.unit)}</strong></span><span>Remaining: <strong>${fmt(rem,k.unit)}</strong></span></div></div>`;}).join('');}
function rHist(){const uid=CU.admin?null:CU.id;const entries=[...(S.entries||[])].filter(e=>uid===null||e.mid===uid).sort((a,b)=>b.date.localeCompare(a.date)||(b.id-a.id)).slice(0,100);const el=document.getElementById('histList');if(!entries.length){el.innerHTML='<div class="empty"><div class="ei">üìÖ</div><p>No entries yet.</p></div>';return;}el.innerHTML=entries.map(e=>{const kpi=(S.kpis||[]).find(k=>k.id===e.kid);const mem=(S.members||[]).find(m=>m.id===e.mid);if(!kpi)return'';const m=CAT[kpi.cat]||CAT.other;const ds=new Date(e.date+'T00:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});const mt=CU.admin&&mem?`<span style="font-size:11px;color:var(--muted);margin-left:8px">(${mem.name})</span>`:'';return `<div class="hentry"><div><div class="hdate">${ds}</div><div class="hkpi">${kpi.name}<span class="hcat ${m.hc}">${m.label}</span>${mt}</div></div><div class="hval">+${Number(e.v).toLocaleString()} <span class="hu">${kpi.unit}</span></div></div>`;}).join('');}
function rAdmin(){document.getElementById('memberSetup').innerHTML=(S.members||[]).map((m,i)=>`<div class="srow"><div class="tbav ${clr(i)}" style="width:30px;height:30px;font-size:12px;border-radius:7px">${ini(m.name)}</div><input class="sin" type="text" value="${m.name}" oninput="updateMemberName(${i},this.value)" placeholder="Name"/><input class="sin" type="text" value="${m.role||''}" oninput="updateMemberRole(${i},this.value)" placeholder="Role" style="max-width:130px"/><input class="sin" type="text" value="${m.password||''}" oninput="updateMemberPassword(${i},this.value)" placeholder="Password" style="max-width:100px"/><button class="rmbtn" onclick="rmMember(${m.id})">√ó</button></div>`).join('');document.getElementById('kpiSetup').innerHTML=(S.kpis||[]).map((k,i)=>`<div class="srow"><input class="sin" type="text" value="${k.name}" oninput="updateKpiName(${i},this.value)" placeholder="KPI" style="min-width:120px"/><input class="sin" type="text" value="${k.unit}" oninput="updateKpiUnit(${i},this.value)" placeholder="Unit" style="max-width:70px"/><select class="scat" onchange="updateKpiCat(${i},this.value)">${['sales','tasks','outreach','other'].map(c=>`<option value="${c}"${k.cat===c?' selected':''}>${CAT[c].label}</option>`).join('')}</select><button class="rmbtn" onclick="rmKpi(${k.id})">√ó</button></div>`).join('');const mbs=S.members||[],kpis=S.kpis||[];if(!mbs.length||!kpis.length){document.getElementById('assignTable').innerHTML='<tr><td style="padding:20px;color:var(--muted)">Add members and KPIs first.</td></tr>';return;}const hc=mbs.map((_,i)=>`<th class="c"><div class="tbav ${clr(i)}" style="width:26px;height:26px;font-size:11px;border-radius:6px;margin:0 auto 4px;color:#fff">${ini(mbs[i].name)}</div>${mbs[i].name.split(' ')[0]}</th>`).join('');const rows=kpis.map(k=>{const cells=mbs.map(m=>{const a=((S.assignments||{})[m.id]||{})[k.id]||{a:false,g:0};return `<td class="c"><input type="checkbox" class="ach" ${a.a?'checked':''} onchange="togA(${m.id},${k.id},this.checked)"/><br><input type="number" class="ginput" value="${a.g||''}" placeholder="goal" ${a.a?'':'disabled'} id="g_${m.id}_${k.id}" onchange="setG(${m.id},${k.id},this.value)" min="0"/></td>`;}).join('');const m=CAT[k.cat]||CAT.other;return `<tr><td style="font-weight:700">${m.icon} ${k.name}<br><span style="font-size:11px;color:var(--muted);font-weight:400">${k.unit} ¬∑ ${m.label}</span></td>${cells}</tr>`;}).join('');document.getElementById('assignTable').innerHTML=`<thead><tr><th>KPI</th>${hc}</tr></thead><tbody>${rows}</tbody>`;document.getElementById('periodSel').value=S.period||'Monthly';document.getElementById('adminPwInput').value=S.adminPassword||'admin123';const viewSel=document.getElementById('viewMemberSel');if(viewSel){viewSel.innerHTML='<option value="">-- Select Member --</option>'+(S.members||[]).map(m=>`<option value="${m.id}">${m.name}</option>`).join('');}}
function updateMemberName(i,v){S.members[i].name=v;}
function updateMemberRole(i,v){S.members[i].role=v;}
function updateMemberPassword(i,v){S.members[i].password=v;}
function updateKpiName(i,v){S.kpis[i].name=v;}
function updateKpiUnit(i,v){S.kpis[i].unit=v;}
function updateKpiCat(i,v){S.kpis[i].cat=v;}
function togA(mid,kid,v){
  if(!S.assignments)S.assignments={};
  if(!S.assignments[mid])S.assignments[mid]={};
  if(!S.assignments[mid][kid])S.assignments[mid][kid]={a:false,g:0};
  const currentGoal=S.assignments[mid][kid].g||0;
  S.assignments[mid][kid]={a:v,g:currentGoal};
  const g=document.getElementById(`g_${mid}_${kid}`);
  if(g){
    g.disabled=!v;
    if(!v){
      g.value='';
      S.assignments[mid][kid].g=0;
    }
  }
}
function setG(mid,kid,v){
  if(!S.assignments)S.assignments={};
  if(!S.assignments[mid])S.assignments[mid]={};
  if(!S.assignments[mid][kid])S.assignments[mid][kid]={a:false,g:0};
  S.assignments[mid][kid].g=Number(v)||0;
  // If setting a goal, make sure it's also assigned
  if(Number(v)>0 && !S.assignments[mid][kid].a){
    S.assignments[mid][kid].a=true;
    const checkbox=document.querySelector(`input[type="checkbox"][onchange*="togA(${mid},${kid}"]`);
    if(checkbox)checkbox.checked=true;
    const goalInput=document.getElementById(`g_${mid}_${kid}`);
    if(goalInput)goalInput.disabled=false;
  }
}
function addMember(){if(!S.members)S.members=[];S.members.push({id:Date.now(),name:'New Member',role:'',password:'password123'});rAdmin();}
function rmMember(id){S.members=(S.members||[]).filter(m=>m.id!==id);rAdmin();}
function addKpi(){if(!S.kpis)S.kpis=[];S.kpis.push({id:Date.now(),name:'New KPI',unit:'units',cat:'tasks'});rAdmin();}
function rmKpi(id){S.kpis=(S.kpis||[]).filter(k=>k.id!==id);rAdmin();}
async function saveAdmin(){
  const btn=document.getElementById('saveAdminBtn');
  if(btn){btn.disabled=true;btn.textContent='Saving‚Ä¶';}
  await push();
  renderAll();
  if(btn){btn.disabled=false;btn.textContent='üíæ Save All Changes';}
  showToast('‚úì Changes saved!');
  // Manually sync once after saving to get any remote updates
  try{
    const r=await fbRead();
    if(r&&Object.keys(r).length){
      const currentJson = JSON.stringify(S);
      const remoteJson = JSON.stringify(r);
      if(currentJson !== remoteJson){
        S = r;
        renderAll();
      }
    }
  }catch(e){}
}
async function resetEntries(){if(!confirm('Clear all entries?'))return;S.entries=[];await push();renderAll();}
async function changeAdminPassword(){const newPw=document.getElementById('adminPwInput').value.trim();if(!newPw){alert('Password cannot be empty');return;}if(confirm('Change admin password to: '+newPw+'?')){S.adminPassword=newPw;await push();showToast('‚úì Password updated!');}}
function viewMemberPerformance(){const sel=document.getElementById('viewMemberSel');const mid=parseInt(sel.value);const container=document.getElementById('memberPerformance');if(!mid){container.innerHTML='';return;}const member=S.members.find(m=>m.id===mid);if(!member){container.innerHTML='';return;}const assigned=asgn(mid);if(!assigned.length){container.innerHTML='<p style="color:var(--muted);padding:20px;text-align:center;">No KPIs assigned to this member.</p>';return;}let html='<div style="margin-top:20px;"><h4 style="margin-bottom:12px;">'+member.name+'\'s KPIs</h4>';html+='<div style="display:flex;flex-direction:column;gap:10px;">';assigned.forEach(({kpi,goal})=>{const val=mTot(mid,kpi.id);const p=pct(val,goal);const m=CAT[kpi.cat]||CAT.other;html+=`<div style="background:var(--cream);border:1px solid var(--border);border-radius:10px;padding:14px;"><div style="font-weight:700;margin-bottom:4px;">${m.icon} ${kpi.name}</div><div style="font-size:12px;color:var(--muted);margin-bottom:8px;">Achieved: <strong style="color:var(--text)">${fmt(val,kpi.unit)}</strong> / Goal: <strong style="color:var(--text)">${fmt(goal,kpi.unit)}</strong></div><div style="height:6px;background:var(--warm2);border-radius:99px;overflow:hidden;"><div style="height:100%;width:${p}%;background:var(${p>=80?'--green':p>=50?'--orange':'--red'});border-radius:99px;"></div></div><div style="font-size:11px;margin-top:4px;text-align:right;font-weight:700;color:var(${p>=80?'--green':p>=50?'--orange':'--red'})">${p}%</div></div>`;});html+='</div></div>';container.innerHTML=html;}
function showToast(msg,bg){const t=document.getElementById('toast');t.textContent=msg;t.style.background=bg||'var(--green)';t.classList.add('on');setTimeout(()=>t.classList.remove('on'),2000);}
</script>
</body>
</html>
